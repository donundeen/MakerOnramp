<script>

class Student{
    constructor(id, name, email, password){
        this.id = id;
        this.name = name;
        this.email = email;
        this.skillTreeItems = [];
        this.groupedSkillTreeItems = null;
        this.relatedSkillTreeItemLists = {};
    }


    display(template){
        console.log("displaying student", this);
    //    this.loadRelatedSkillTrees();
       // this.documentationSlideEmbedURL = generateDocumentationSlideEmbedURL(this.skillTreeItem.DocumentationSlidesLink);
        let html = template(this);
        console.log("html", html);
        return html;       
    }

    load(){
        let self = this;
        this.relatedSkillTreeItemLists = {};
        // get the skill tree items for the student
        return new Promise((resolve, reject) => {
            self.getStudentSkillTreeItems()
            .then(()=>this.mergeAllSkillTreeItemData())
            .then(result => {
                this.groupSkillTreeItemsByLevel();
                resolve(this.groupedSkillTreeItems);
            })
            .catch(error => {
                reject(error);
            });
        });

    }

    create(){

    }

    update(){

    }

    delete(){

    }

    groupSkillTreeItemsByLevel(){
        let levelGroupedSkillTreeItems = {};
        // iterate through the grouped skill tree items
        for(let skillTreeName in this.groupedSkillTreeItems){
            let skillTreeItemList = this.groupedSkillTreeItems[skillTreeName];
            // iterate through the skill tree item list
            for(let skillTreeItem of skillTreeItemList){
                let level = skillTreeItem.Level;
                if(!levelGroupedSkillTreeItems[skillTreeName]){
                    levelGroupedSkillTreeItems[skillTreeName] = {};
                }
                if(!levelGroupedSkillTreeItems[skillTreeName][level]){
                    levelGroupedSkillTreeItems[skillTreeName][level] = [];
                }
                levelGroupedSkillTreeItems[skillTreeName][level].push(skillTreeItem);
            }
        }
        this.groupedSkillTreeItems = levelGroupedSkillTreeItems;
    }
    
    loadRelatedSkillTrees(){
        let self = this;
        return new Promise((resolve, reject) => {
            console.log("loading related skill trees for student", this.id);
            let promises = [];
            for(let skillTreeName in this.groupedSkillTreeItems){
                promises.push(self.loadRelatedSkillTreeItems(skillTreeName));
            }
            Promise.all(promises).then(() => {
                console.log("complete skill tree items, all sheets loaded", this.relatedSkillTreeItemLists);
                resolve(self.relatedSkillTreeItemLists);
            });
        });
    }

    loadRelatedSkillTreeItems(skillTreeName){
        let self = this;
        return new Promise((resolve, reject) => {
            let skillTreeItemList = new SkillTreeItemList();
            skillTreeItemList.sheetName = skillTreeName;
            skillTreeItemList.load().then(skillTreeItemList => {
                self.relatedSkillTreeItemLists[skillTreeName] = skillTreeItemList;
                resolve(skillTreeItemList);
            });
        });
    }

    mergeAllSkillTreeItemData(){
        console.log("merging all skill tree item data", this);
        let self = this;
        console.log(self);
        return new Promise((resolve, reject) => {
            self.loadRelatedSkillTrees().then(relatedSkillTreeItemLists => {
                for(let skillTreeName in relatedSkillTreeItemLists){
                    let fullSkillTreeItemList = relatedSkillTreeItemLists[skillTreeName];
                    // for each item in the full skill tree item list, merge the items data with the student skill tree item with the matching SkillTreeName and SkillTreeItemID
                    for(let skillTreeItem of fullSkillTreeItemList){
                        let studentSkillTreeItem = self.skillTreeItems.find(item => item.SkillTreeName === skillTreeItem.SkillTreeName && item.SkillTreeItemID === skillTreeItem.SkillTreeItemID);
                        if(studentSkillTreeItem){
                            studentSkillTreeItem = Object.assign(studentSkillTreeItem, skillTreeItem);
                        }
                    }
                }
                resolve(self.skillTreeItems);
            });
        });
    }

    groupSkillTreeItemsBySkillTreeName(){
        if(this.groupedSkillTreeItems){
            return;
        }
        this.groupedSkillTreeItems = {};
        this.skillTreeItems.forEach(item => {
            if(!this.groupedSkillTreeItems[item.SkillTreeName]){
                this.groupedSkillTreeItems[item.SkillTreeName] = [];
            }
            this.groupedSkillTreeItems[item.SkillTreeName].push(item);
        });
    }


    getStudentSkillTreeItems(){
        let self = this;
        return new Promise((resolve, reject) => {
            console.log("getting user skill tree items",self.id);
            if(localStorage["userSkillTreeItems"+ self.id]){
                console.log("Student using local storage");
                self.skillTreeItems = JSON.parse(localStorage["userSkillTreeItems"+self.id]);
                console.log("currentUserSkillTreeItems", self.skillTreeItems);
                self.groupSkillTreeItemsBySkillTreeName();    
                resolve(self.skillTreeItems);
            }else{
                google.script.run.withSuccessHandler(function(result) {
                    console.log(" got result from server: " , result);
                    self.skillTreeItems = result;
                    localStorage["userSkillTreeItems"+self.id] = JSON.stringify(self.skillTreeItems);
                    self.groupSkillTreeItemsBySkillTreeName();    
                    resolve(self.skillTreeItems);
                }).getSkillTreeItemsForStudent(self.id);
            }
        });
    }

    hasSkillTreeItem(skillTreeName, skillTreeItemID){
        if(!this.skillTreeItems){
            console.log("no current user skill tree items");
            return false;
        }
        let result = this.skillTreeItems.some(item => item.SkillTreeName === skillTreeName && item.SkillTreeItemID === skillTreeItemID);
        return result;
    }

    addSkillTreeItem(skillTreeName, skillTreeItemID){
        console.log("adding skill tree item for student: " ,this.id, skillTreeItemID);
        let self = this;
        google.script.run.withSuccessHandler(function(result) {
            console.log(" got result from server: " , result);
            self.skillTreeItems.push(result);
            localStorage["userSkillTreeItems"+self.id] = JSON.stringify(self.skillTreeItems);
        }).addSkillTreeItemForStudent(  self.id, skillTreeItemID, skillTreeName);
    }
}



</script>